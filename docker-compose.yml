version: '3.8'

services:
  shattered-pixel-dungeon:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: shattered-pixel-dungeon
    image: shattered-pixel-dungeon:latest
    runtime: nvidia
    environment:
      - DISPLAY=${DISPLAY:-:0}
      - XAUTHORITY=/tmp/.Xauthority
      # Устанавливаем HOME и XDG_DATA_HOME для правильного пути сохранений
      - HOME=/home/gamer
      - XDG_DATA_HOME=/home/gamer/.local/share
      # NVIDIA переменные окружения
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      # Используем GPU, если доступен, иначе программный рендеринг
      - LIBGL_ALWAYS_SOFTWARE=${LIBGL_ALWAYS_SOFTWARE:-0}
      # PulseAudio для звука
      - PULSE_SERVER=unix:/tmp/pulse/native
    volumes:
      # Монтируем X11 socket для отображения на локальном дисплее
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Монтируем X11 авторизацию (если файл существует)
      - ~/.Xauthority:/tmp/.Xauthority:ro
      # Монтируем PulseAudio socket для звука
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/pulse/native:/tmp/pulse/native:ro
      # Монтируем директорию для сохранений игры в локальную папку
      - ./vol/game-data:/home/gamer/.local/share
    network_mode: host
    # Требуется для доступа к X11
    privileged: false
    stdin_open: true
    tty: true
